upstream backend {
   server app:5000;
}

server {
   listen 80;
   server_name localhost;

   location / {
   # 1. First define all headers
   proxy_set_header Host $host;
   proxy_set_header X-Real-IP $remote_addr;
   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   proxy_set_header X-Forwarded-Proto $scheme;
   proxy_set_header Cookie $http_cookie;

   # 2. Set target variable
   set $target http://backend;  # default

   # 3. Check if cookie exists and update target accordingly  
   if ($cookie_server_ip) {
       set $target http://$cookie_server_ip:5000;
   }

   # 4. Execute proxy pass at the end
   proxy_pass $target;
}
}